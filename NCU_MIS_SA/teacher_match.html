<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="statics/css/teacher_match.css">
    <script src="statics/js/jquery-3.4.1.min.js" crossorigin="anonymous"></script>
    <title>老師成交紀錄</title>
</head>
<body>
<div id="Header">
		<div class="imgHolder"><a href="index.html"><img src="statics/img/Logo.png" alt="Logo"></a></div>
		<h1> 老師成交紀錄</h1>
		<label id="teacher_name"></label>
</div>

<div id="content">	
        
	<div id="Sidebar">
    			<p></p>
    			<div class="list"> 老師會員中心</div>
   					<div class="list">
        					<ul> 
            					<li><a href="teacher_edit.html">修改老師會員資料</a></li>
            					<li><a href="teacher_interview.html">面試管理</a></li>
            					<li><a href="teacher_match.html">成交紀錄</a></li>
        					</ul>
    				</div>
	</div>        			


	<div id="Body">
    	<div id="flashMessage" class="message" style="display: none;"></div>
    	<h3>所有成交案件名單</h3>

    	<table id="table">
       		<thead>
        	<tr>
            	<th>案件編號</th>
            	<th>上課科目</th>
            	<th>面談時薪</th>
        	</tr>
        	</thead>
        	<tbody>
        	</tbody>

    	</table>

	</div>
</div>

<div style='clear:both;'></div>

<div id="Footer">®安心168家教網 created by 2019</div>

<script type="text/javascript">
	$(document).ready(function() {
	    getLogin();
	});
	
    var states = ['面試','成功','失敗'];
    
    function getInterview(){
    	
    	$.ajax({
            type: "GET",
            url: "api/interview.do",
            data: "teacher_id="+loginTID,
            crossDomain: true,
            cache: false,
            dataType: 'json',
            timeout: 5000,
            success: function (response) {
                if(response.status == 200){
              	  updateTable(response.response.data);
                }
                console.log(response);
            },
            error: function () {
                alert("無法連線到伺服器！");
            }
      });
    }
    
 	//更新表格
    function updateTable(data) {	//做出html要的表單形式
        $("#table > tbody").empty();
        var table_html = '';
        $.each(data, function(index, value) {	//data為陣列
        	if(states[value['state']] =="成功"){
        		table_html += '<tr><td scope="row">'+ '<a href="case_detail.html?id=' + value['case_id'] + '">' + value['case_id'] + '</a></td>';
                table_html += '<td>' + value['subject'] + '</td>';
                table_html += '<td>' + value['wage']+ '</td></tr>';
        	}
        });

        $("#table > tbody").append(table_html);
    }
	
 
	//預設都是0，如果有人登入會去改，若其他部分又去取東西再用這個
    var loginTID=0;
    var loginEmail;
	
    function getLogin(){
		$.ajax({
			type: "GET",
			url: "api/login.do",
			crossDomain: true,
			cache: false,
			dataType: 'json',
			timeout: 5000,
			success: function (response) {
				if(response.status == 200){
					if(response['response']['memberType']!="teacher"){
						noTLogin();
					}
					else{
						updateLogIn(response);
						//getMember();
						getInterview();
					}
				}
				else{	//沒有登入
					noTLogin();
				}
				console.log(response);
			},
			error: function () {
				alert("無法連線到伺服器！");
			}
		});
	}
	
	//更新顯示登入會員的地方
	function updateLogIn(response){
		$("#teacher_name").empty();
      	var label_html = "";
      	var name = response['response']['name'];
      	var typeStr = "老師";
      	//alert(type);
      	
      	loginTID = response['response']['id'];
      	//alert("loginTID: "+loginTID);
      	
      	label_html += '<label> '+ name + typeStr +'，您好</label>';
      	label_html += '<button id="logoutBtn">登出</button>';
      	$("#teacher_name").append(label_html);
      	var $form = $('#logoutBtn');
		$form.click(function(){
			logout();
		});
    }
	
	//登出
	function logout(){
		$.ajax({
			type: "DELETE",
			url: "api/login.do",
			cache: false,
			dataType: 'json',
			timeout: 5000,
			success: function (response) {
				//如果你們前端登入成功要新跳視窗出來就打在這
				if (response.status == 200) {
					loginPID=0;
					loginTID=0;
					alert(response.message);
					noTLogin();
				}
			},
			error: function () {
				alert("無法連線到伺服器！");
			}
		});
	}
	
	//沒會員登入的長相
	function noTLogin(){
		alert("未登入老師會員，將跳轉至首頁!");
		window.location.assign("http://localhost:8090/NCU_MIS_SA_Group16/");
	}
</script>


</body>
</html>