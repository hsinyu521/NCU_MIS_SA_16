<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>案件詳情</title>

        <script src="statics/js/jquery-3.4.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="statics/css/design_case.css">

</head>


<body>	
	<div id="container">

		<div id="header">
			<a href="index.html"><img src="statics/img/Logo.png" alt="Logo"></a>
			<div align="right">
				<label id="member_name"></label>
			</div>
		</div>

		<div id="content">

			<h2>案件編號:NO.<span id="id">{{id}}</span></h2>

			<h3>上課內容</h3><hr>

			<div>對象:<span id="grade">{{grade}}</span></div>
			<div>上課科目:<span id="subject">{{subject}}</span></div>
			<div>上課地點:<span id="location">{{location}}</span></div>
			<div>薪資待遇:<span id="wage">{{wage}}</span></div>
			<div>上課時間:<span id="teachtime">{{teachtime}}</span></div>

			<h3>老師條件需求</h3><hr>

			<div>教學經驗:<span id="exper">{{exper}}</span></div>

			<div id="secend_content"></div>
					<div class="submit"><input type="button" value="我要應徵" id="submit"></div>
			
		</div>
	</div>
	<script>
	  $(document).ready(function(){
		  checkPLogIn();
	  });
	  //取得網址參數
	  var url_string = window.location.href;
	  var url = new URL(url_string);
	  var id = url.searchParams.get("id");
	  
	  function getCaseData() {
		  $.ajax({
	          type: "GET",
	          url: "api/case.do",
	          data: "id=" + id,
	          crossDomain: true,
	          cache: false,
	          dataType: 'json',
	          timeout: 5000,
	          success: function (response) {
	              if(response.status == 200){
	            	  updateHTML(response.response.data);
	              }
	          },
	          error: function () {
	              alert("無法連線到伺服器！");
	          }
	    });
	  }
	  
	  getCaseData();
	  
	  function updateHTML(data) {
		  $("#id").html(data['id']);
		  $("#grade").html(data['grade']);
		  $("#subject").html(data['subject']);
		  $("#location").html(data['teach_county']+data['teach_region']);
		  $("#wage").html(data['wage']);
		  $("#teachtime").html(data['teachtime']);
		  $("#exper").html(data['teach_experience']);
	
	  }
	  
	//預設都是0，如果有人登入會去改，若其他部分又去取東西再用這個
	var loginPID=0;
	var loginTID=0;
	var loginEmail;
	    
	//看有沒有家長會員登入
	function checkPLogIn(){
		// 將資料組成JSON格式
		var data_object = {
				'option':"login"
		};
		// 將JSON格式轉換成字串
		var data_string = JSON.stringify(data_object);
	          
			$.ajax({
				type: "GET",
				url: "api/parent.do",
				crossDomain: true,
				data: "option=login",
				cache: false,
				dataType: 'json',
				timeout: 5000,
				success: function (response) {
					if(response.status == 200){
						updateLogIn(response, "家長");
						loginPID = response['response']['data'][0]['id'];
						loginTID=0;
						loginEmail = response['response']['data'][0]['email'];
					}
					else{	//沒家長會員登入再去看有沒有老師會員登入
						checkTLogIn();
					}
					console.log(response);
				},
				error: function () {
					alert("無法連線到伺服器！");
				}
			});
		}
		
		//看有沒有老師會員登入
		function checkTLogIn(){
			// 將資料組成JSON格式
			var data_object = {
				'option':"login"
			};
			// 將JSON格式轉換成字串
			var data_string = JSON.stringify(data_object);
	          
			$.ajax({
				type: "GET",
				url: "api/teacher.do",
				crossDomain: true,
				data: "option=login",
				cache: false,
				dataType: 'json',
				timeout: 5000,
				success: function (response) {
					if(response.status == 200){
						updateLogIn(response, "老師");
						loginTID = response['response']['data'][0]['id'];
						loginPID=0;
						loginEmail = response['response']['data'][0]['email'];
					}
					else{	//沒有就顯示平常的樣子
						loginTID=0;
						loginPID=0;
						showInit();
					}
					console.log(response);
				},
				error: function () {
					alert("無法連線到伺服器！");
				}
			});
		}
		
		//沒會員登入的長相
		function showInit(){
			//上面20幾行的loginOrNot不要直接打東西上去，打在這，不然有登入的人還是會先閃過那個
			$("#member_name").empty();
			var label_html = '<label> 訪客您好 </label>';
			$("#member_name").append(label_html);
		}
		
		
		//更新顯示登入會員的地方
		function updateLogIn(response, str){
			$("#member_name").empty();
	      	var label_html = "";
	      	var name = response['response']['data'][0]['name'];
	      	label_html += '<label> '+ name + str + '，您好 </label>';;
	      	label_html += '<button id="logoutBtn">登出</button>';
	      	$("#member_name").append(label_html);
	      	var $form = $('#logoutBtn');
			$form.click(function(){
				logout();
			});
	    }
		
		//登出
		function logout(){
			var urlstr = "";
			if(loginPID!=0){
				urlstr = "api/parent.do";
			}
			else if(loginTID!=0){
				urlstr = "api/teacher.do";
			}
			//alert("loginPID="+loginPID+" loginTID="+loginTID);
			// 將資料組成JSON格式
			var data_object = {
				'email': loginEmail,
				'option':"logout"
			};
			// 將JSON格式轉換成字串
				var data_string = JSON.stringify(data_object);
			//alert("urlstr: "+urlstr);
			
			$.ajax({
				type: "PUT",
				url: urlstr,
				data: data_string,
				cache: false,
				dataType: 'json',
				timeout: 5000,
				success: function (response) {
					//如果你們前端登入成功要新跳視窗出來就打在這
					if (response.status == 200) {
						alert(response.message);
						loginPID=0;
						loginTID=0;
						//showInit();
						window.location.reload();	//刷新頁面
					}
				},
				error: function () {
					alert("無法連線到伺服器！");
				}
			});
		}
	  
	  </script>
</body>
</html>