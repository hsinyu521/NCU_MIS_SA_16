<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<title>家長會員更改資訊</title>

    <link rel="stylesheet" type="text/css" href="statics/css/parent_change.css">
    <script src="statics/js/jquery-3.4.1.min.js" crossorigin="anonymous"></script>

</head>


<body>	
	<div id="container">
		<div id="header">
        	<a href="index.html"><img src="statics/img/Logo.png" alt="Logo" width="200" height="100"></a>
        	<label id="parent_name"></label>
    	</div>
			
		<div id="content">
					
					<form id='form'>
						
						<div style="display:none;"><input type="hidden" name="_method" value="POST"></div>

						<div id="input" style="border: none">
							<div class="input text required">
								<label for="member_name">姓名</label>
								<input type="text" name="name" maxlength="30" id="member_name" required="required" disabled>				
							</div>
							
							<div class="input email required">
								<label for="member_email">email</label>
								<input type="email" name="email" maxlength="50" id="member_email" required="required" disabled>
							</div>

							<div class="input password required">
								<label for="member_password">密碼</label>
								<input type="password" name="password" maxlength="30" id="member_password" required="required">
							</div>
	
							<div class="input tel required">
								<label for="member_tel">手機</label>
								<input type="tel" name="tel" maxlength="10" id="member_tel" required="required" >
							</div>
	
							<div class="input gender">
							<label for="member_gender">性別</label>
								<select id="select_gender" disabled>
	  								<option value="1" selected="selected">男</option>
	  								<option value="2">女</option>
								</select>
							</div>
						</div>

						<div class="submit"><input type="button" value="修改" id="submit"></div>
						
				</form>

			
		</div>

		<div id="table2">
			<a href="parent_change_information.html" class="button"><input type="button" value="修改家長會員資訊"  id="parent_information"></a><br>
			<a href="add_case.html" class="button"><input type="button" value="新增案件"  id="add_case"></a><br>
			<a href="parent_interview.html" class="button"><input type="button" value="面試管理"  id="interview"></a><br>
			<a href="log_in.html" class="button"><input type="button" value="管理案件狀態"  id="management"></a><br>
			<a href="log_in.html" class="button"><input type="button" value="成交紀錄"  id="closing"></a>


		</div>
	</div>
</body>

		<script type="text/javascript">
			$(document).ready(function(){
				getLogin();
				var $form = $('#submit');
				$form.click(function(){
					submit();
				});
			});
			
			function submit(){
				var new_password = $('#member_password').val();
				var new_tel = $('#member_tel').val();
				var password_rule = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{8,}$/;
				var tel_rule=/^09[0-9]{8}$/;
				
				if(new_password.length==0 || new_tel.length==0){
					alert("所有欄位皆為必填");
				}
				else if(!password_rule.test(new_password)) {
					alert("密碼格式不符，長度至少8，且至少包含一個數字和英文字母！");
				}
				else if(!tel_rule.test(new_tel)){
					alert("手機號碼格式不符！");
				}
				else{
					// 將資料組成JSON格式
                    var data_object = {
                        "id": loginPID,
                        "password": new_password,
                        "cellphone": new_tel
                    };

                    // 將JSON格式轉換成字串
                    var data_string = JSON.stringify(data_object);
                    
					$.ajax({
						type: "PUT",
						url: "api/parent.do",
						data: data_string,
						cache: false,
						dataType: 'json',
						timeout: 5000,
						success: function (response) {
							alert(response.message);
							//$('#flashMessage').html(response.message);
							//$('#flashMessage').show();
							if(response.status == 200){
								
							}
						},
						error: function () {
							alert("無法連線到伺服器！");
						}
					}); //ajax end
				} //else end
			} //submit end
			
			function getMember() {	//取得家長原資料
                //alert("in edit.html getMember(), id= "+loginPID);
                $.ajax({
                    type: "GET",
                    url: "api/parent.do",
                    crossDomain: true,
                    data: "id="+loginPID,
                    cache: false,
                    dataType: 'json',
                    timeout: 5000,
                    success: function (response) {
                        if(response.status == 200){
                        	document.getElementById('member_name').value = response['response']['data'][0]['name'];
                        	document.getElementById('member_email').value = response['response']['data'][0]['email'];
                        	document.getElementById('member_password').value = response['response']['data'][0]['password'];
                        	document.getElementById('member_tel').value = response['response']['data'][0]['cellphone'];
                        	$('#select_gender')[0].selectedIndex = response['response']['data'][0]['gender']-1;
                        }
                        console.log(response);
                    },
                    error: function () {
                        alert("無法連線到伺服器！");
                    }
                });
            }
			
			//如果有人登入會去改，若其他部分又去取東西再用這個
		    var loginPID=0;
			
		    function getLogin(){
				$.ajax({
					type: "GET",
					url: "api/login.do",
					crossDomain: true,
					cache: false,
					dataType: 'json',
					timeout: 5000,
					success: function (response) {
						if(response.status == 200){
							if(response['response']['memberType']!="parent"){
								noPLogin();
							}
							else{
								updateLogIn(response);
								getMember();	//顯示原值
							}
						}
						else{	//沒有登入
							noPLogin();
						}
						console.log(response);
					},
					error: function () {
						alert("無法連線到伺服器！");
					}
				});
			}
			
			//更新顯示登入會員的地方
			function updateLogIn(response){
				$("#parent_name").empty();
		      	var label_html = "";
		      	var name = response['response']['name'];
		      	var typeStr = "家長";
		      	//alert(type);
		      	
		      	loginPID = response['response']['id'];
		      	//alert("loginPID: "+loginPID);
		      	
		      	label_html += '<label> '+ name + typeStr +'，您好</label>';
		      	label_html += '<button id="logoutBtn">登出</button>';
		      	$("#parent_name").append(label_html);
		      	var $form = $('#logoutBtn');
				$form.click(function(){
					logout();
				});
		    }
			
			//登出
			function logout(){
				$.ajax({
					type: "DELETE",
					url: "api/login.do",
					cache: false,
					dataType: 'json',
					timeout: 5000,
					success: function (response) {
						//如果你們前端登入成功要新跳視窗出來就打在這
						if (response.status == 200) {
							loginPID=0;
							alert(response.message);
							noPLogin();
						}
					},
					error: function () {
						alert("無法連線到伺服器！");
					}
				});
			}
			
			//沒會員登入的長相
			function noPLogin(){
				alert("未登入家長會員，將跳轉至首頁!");
				window.location.assign("http://localhost:8090/NCU_MIS_SA_Group16/");
			}
		</script>



		
</html>






