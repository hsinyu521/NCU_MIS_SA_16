<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>家長會員清單</title>
  <link rel="stylesheet" type="text/css" href="statics/css/show.css">
  <script src="statics/js/jquery-3.4.1.min.js" crossorigin="anonymous"></script>
</head>

<body>
<div id="container">
  <div id="Header">
      <div class="imgHolder"><a href="home.html"><img  src="statics/img/Logo.png" alt="Logo"></a></div>
      <h1>管理者中心</h1>
      <label id="manager_name"></label>
  </div>

    <div id="content">
      <h2>會員清單</h2>
      <a href="">檢視所有管理者</a>
      <a href=""></a>
      <a href="show_teachers.html">檢視所有老師會員</a>
      <button id="changeMember">檢視另一個</button>
      <div id="loginOrNot">
        <label></label>
      </div>


      <div id="flashMessage" class="message" style="display: none;"></div>

      <table id="table">
       <thead>
        <tr>
          <th>編號</th>
          <th>姓名</th>
          <th>電郵</th>
          <th>手機</th>
          <th>性別</th>
          <th>功能</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
  </div>

  <div id="Footer">®安心168家教網 created by 2019</div>

</div>
	<script type="text/javascript">
	$(document).ready(function() {
	    getLogin();
	});
	
	var nowShow = 0;	//0為家長、1老師
	//
	var $form = $('#changeMember');
	$form.click(function(){
		nowShow = (nowShow+1)%2;
		if(nowShow == 0){
			getAllPMember();
		}
		else if(nowShow == 1){
			getAllTMember();
		}
		
	});
	
	//取得所有老師會員列表
	function getAllPMember() {
    	$.ajax({
            type: "GET",
            url: "api/parent.do",
            crossDomain: true,
            cache: false,
            dataType: 'json',
            timeout: 5000,
            success: function (response) {
                if(response.status == 200){
                    updateTable(response.response.data);
                }
                console.log(response);
            },
            error: function () {
                alert("無法連線到伺服器！");
            }
    	});
	}
	
	//取得所有老師會員列表
	function getAllTMember() {
    	$.ajax({
            type: "GET",
            url: "api/teacher.do",
            crossDomain: true,
            cache: false,
            dataType: 'json',
            timeout: 5000,
            success: function (response) {
                if(response.status == 200){
                    updateTable(response.response.data);
                }
                console.log(response);
            },
            error: function () {
                alert("無法連線到伺服器！");
            }
    	});
	}
	
	// 更新會員列表表格
    function updateTable(data) {	//做出html要的表單形式
        $("#table > tbody").empty();
        var table_html = '';
        $.each(data, function(index, value) {	//data為陣列
        	table_html += '<tr><td scope="row">' + value['id'] + '</td>';
            table_html += '<td>' + value['name'] + '</td>';
            table_html += '<td>' + value['email'] + '</td>';
            table_html += '<td>' + value['cellphone'] + '</td>';
            table_html += '<td>' + value['gender'] + '</td>';
            table_html += '<td>' + '<a href="javascript: deleteMember(' + value['id'] + ');">刪除</a></td></tr>';
        })

        $("#table > tbody").append(table_html);
    }
	
	//刪除會員
    function deleteMember(id) {
    	var urlStr = "";
		var delwho = "";
    	if(nowShow==0){
    		urlStr = "api/parent.do";
        	delwho = "家長";
        }
        else{
        	urlStr = "api/teacher.do";
        	delwho = "老師";
        }
        var check = window.confirm("確認刪除該"+delwho+"會員？");
        if (check == true) {
            console.log("You pressed OK!");
            var request = {'id': id};
            var data_string = JSON.stringify(request);
            
            $.ajax({
                type: "DELETE",
                url: urlStr,
                crossDomain: true,
                data: data_string,
                cache: false,
                dataType: 'json',
                timeout: 5000,
                success: function (response) {
                    if(response.status == 200){
                        alert("成功!已成功刪除");
                        if(nowShow==0){
                        	getAllPMember();
                        }
                        else{
                        	getAllTMember();
                        }
                    }
                    console.log(response);
                },
                error: function () {
                    alert("無法連線到伺服器！");
                }
            });
        }
        else {
            console.log("You pressed Cancel!");
        }
    }
	
	//如果有人登入會去改，若其他部分又去取東西再用這個
    var loginMID=0;
	
    function getLogin(){
		$.ajax({
			type: "GET",
			url: "api/login.do",
			crossDomain: true,
			cache: false,
			dataType: 'json',
			timeout: 5000,
			success: function (response) {
				if(response.status == 200){
					if(response['response']['memberType']!="manager"){
						noPLogin();
					}
					else{
						updateLogIn(response);
						getAllPMember();	//登入成功才能顯示
					}
				}
				else{	//沒有登入
					noPLogin();
				}
				console.log(response);
			},
			error: function () {
				alert("無法連線到伺服器！");
			}
		});
	}
	
	//更新顯示登入會員的地方
	function updateLogIn(response){
		$("#manager_name").empty();
      	var label_html = "";
      	var name = response['response']['name'];
      	var typeStr = "管理者";
      	//alert(type);
      	
      	loginMID = response['response']['id'];
      	//alert("loginPID: "+loginPID);
      	
      	label_html += '<label> '+ name + typeStr +'，您好</label>';
      	label_html += '<button id="logoutBtn">登出</button>';
      	$("#manager_name").append(label_html);
      	var $form = $('#logoutBtn');
		$form.click(function(){
			logout();
		});
    }
	
	//登出
	function logout(){
		$.ajax({
			type: "DELETE",
			url: "api/login.do",
			cache: false,
			dataType: 'json',
			timeout: 5000,
			success: function (response) {
				//如果你們前端登入成功要新跳視窗出來就打在這
				if (response.status == 200) {
					loginMID=0;
					alert(response.message);
					noPLogin();
				}
			},
			error: function () {
				alert("無法連線到伺服器！");
			}
		});
	}
	
	//沒會員登入的長相
	function noPLogin(){
		alert("未登入管理者會員，將跳轉至首頁!");
		window.location.assign("http://localhost:8090/NCU_MIS_SA_Group16/");
	}
	</script>
</body>

</html>
